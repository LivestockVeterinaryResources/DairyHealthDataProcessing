---
title: "Data Dictionary"
format: html
execute:
  echo: false
  warning: false
  message: false
embed-resources: true
---


```{r}
library(tidyverse)
library(arrow)
```


```{r file list}
master_sk<-NULL

list_intermediate_files<-list.files('data/intermediate_files')

fxn_graph_file_skim <- function(file_name) {
  df <- read_parquet(file.path('data/intermediate_files', file_name))
  sk_df <- skimr::skim(df) %>%
    mutate(parquet_file_name = file_name) %>%
    arrange(skim_variable)
  
  ggplot(sk_df) +
    geom_bar(aes(x = skim_variable, y = complete_rate, fill = skim_type), stat = 'identity') +
    facet_wrap(~parquet_file_name) +
    coord_flip() +
    theme_bw() +
    scale_fill_viridis_d()
}

```


This report contains a list of variable names for the files in that are created after the data is processed. Most are self explanatory.  Location of the files are in data/intermediate_files/ folder.
In all tables the variable that starts with location indicates the farm/site of the event or calculation.

## Animals

This file lists each animal as a row. id_animal is the unique identifier of each animal. There should be one unique date for each date in this table, but sometimes there is not. Thus there are date_XXX_max variables.
```{r animals}

fxn_graph_file_skim("animals.parquet")

              
```

## Animal Lactations

This file lists each animal lactation as a row. id_animal_lact is the unique identifier of each animal lactation. There should be one unique date for each date in this table, but sometimes there is not. Thus there are date_XXX_max variables.
```{r animal lact}

fxn_graph_file_skim("animal_lactations.parquet")
              
```

## Events Formatted

This is the main fundamental file driving the values in all other files. This file was created using the EVENTS\2S2000C #1 #2 #4 #5 #6 #11 #12 #13 #15 #28 #29 #30 #31 #32 #38 #40 #43 command in Dairy Comp 305.

Each row is an "event" which specifies the animal, phase (lactation), date, and description (event, remark, protoocls etc.) of what happened to that animal on that day. Usually the disease and treatment information is found by custom parsing this information.

The events_formated files drops the original column names and uses standard ones which have been formatted.  If there is a problem with the formatting the events_all_columns file can be used to chase any issues.  

```{r}
fxn_graph_file_skim("events_formatted.parquet") 

```

## Events parsed

This file is a further processed file from events_formatted where disease and treatment information has been parsed out into separate columns.

```{r, fig.height=12}

fxn_graph_file_skim("events_parsed.parquet")

```

# Denominators (in Development) 

This is in active development and not yet finalized. Currently there are 3 denominator files that give denominator values for the past year.  The are overall, by DIM and by month. We plan to give you more customized options in the future.

## Herd Denominators

``` {r}
#| fig.height: 3

fxn_graph_file_skim("herd_denominators.parquet") 

```

## Herd DIM Denominators

Inventory for past year in 13 30 DIM windows for

``` {r}
#| fig.height: 3

fxn_graph_file_skim("herd_dim_denominators.parquet") 

```

## Herd Denominators by month

Monthly inventory for the past year

``` {r}
#| fig.height: 3

fxn_graph_file_skim("herd_season_denominators.parquet") 

```


## Standard Denominators

### Calendar Time

These denominators are created based on the cut points provided in master processing.  
You may choose any number of days in each period and add additional denominators.  
Standard options are: 21, 30, 90, 365 days.
The denominator file name will have the number of days in the period in that file.

The examples below come from the Yearly denominator file.  However the format is the same regarless of period length. 


#### Yearly Denominators

``` {r}
#| fig.height: 3

fxn_graph_file_skim("denominator_by_lact_group_time_period365.parquet") 

```

#### Denominator Types

There are 2 basic types of denominators in these files: 

1)  Counts by Lactation Group

2)  Counts by Lactation Group and Day of Phase (Days in Milk for cows, Days of Age for Heifers)

##### Counts by Lactation Group

These have a deno_type that begins with "lact_" are lactation group counts.


```{r}
deno365<-read_parquet("data/intermediate_files/denominator_by_lact_group_time_period365.parquet")

sort(unique(deno365$deno_type))
```

Here is a plot comparing denominator type options

```{r}
ggplot(deno365%>%filter(!(str_detect(deno_type, 'dop_'))))+
  geom_point(aes(x = date_time_period_start, y = ct_animal_time_periods, color = `Lactation Group`))+
  ylim(c(0, NA))+
  facet_grid(location_lact_list~deno_type, scales = 'free_y')+
  theme_bw()+
  labs(title = 'Animal Periods (ct_animal_periods)')

```

Here is a plot displaying the counts when the denominator type `dop_lact_basic' is selected.
This plot only shows selected day of phase categories for simplicity. 

```{r}
ggplot(deno365%>%
         filter(deno_type %in% 'dop_lact_basic')%>%
         filter(day_of_phase_group %in% c(sort(unique(deno365$day_of_phase_group))[c(1, 8, 13, 14)])))+
  geom_point(aes(x = date_time_period_start, y = ct_animal_time_periods, color = day_of_phase_group))+
  ylim(c(0, NA))+
  facet_grid(location_lact_list~`Lactation Group`, scales = 'free_y')#+
  #theme(legend.position = 'top')

```

