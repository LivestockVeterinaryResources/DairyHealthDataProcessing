---
title: "Create Denominators"
format: 
  html:
    embed-resources: true
editor: source
execute:
  echo: true
  message: false
  warning: false
params:
  denominator_granularity: 30
---

```{r}
library(tidyverse)
library(arrow)
library(dtplyr)

source('functions/fxn_dt_base.R')
source('functions/fxn_denominator_eligibility.R')
source('functions/fxn_standardize_cow_breed.R')


```

```{r}
#denominator base files -------------------
animals<-read_parquet('data/intermediate_files/animals.parquet') #each row is an animal

animal_lactations<-read_parquet('data/intermediate_files/animal_lactations.parquet') #each row is an animal lactation

animal_event_existance<-read_parquet('data/intermediate_files/events_all_columns.parquet')%>% #add a few parameters to animal
  group_by(id_animal)%>%
  summarize(
            animal_lact_min = min(lact_number), #lowest lactation number in data set
            animal_lact_max = max(lact_number), #highest lactation numer in data set
            animal_date_event_min = min(date_event, na.rm = TRUE), #first animal event in data set
            animal_date_event_max = max(date_event, na.rm = TRUE))%>% #last animal event in data set
  ungroup()


#---------------------------
data_pull_min<-min(animals$data_pull_date_min)
data_pull_max<-max(animals$data_pull_date_max)

```


## define calendar days for calculations 

This creates a list of calendar days from 1200 days prior to the most recent event date

```{r}
#get a list of dates for 1200 days before the final event in data set, uses the parameter "denominator granularity"
calendar<-tibble(date_calendar = seq.Date(from = data_pull_max-1500, 
                                          to = data_pull_max, 
                                          by = params$denominator_granularity))
```


## define list of animals

This is the base data for denominator calculations.  
Each row is a unique animal lactation (id_animal_lact). 
This is then joined to the animal data to make sure all dates for eligibility are available if needed.  

In this base version of denominators, an animal is eligible to be counted if she exists on the reference day.  

There are example functions for all_lactation, milking, dry. 
Code can easily be modified to accept other eligibility criteria.


```{r}
#base data frame for denominator.  Each row is an animal lactation, joined to animal data so that all important dates are available
deno_base<-animal_lactations |> 
  left_join(animals) %>%
  left_join(animal_event_existance)%>%
  mutate(
     lact_status = case_when(
      is.na(date_archive)~'Active', 
      TRUE~'Archived' ),
     
    date_lact_start = case_when(
      lact_number == 0 ~ date_birth, 
      lact_number >0~date_fresh, 
      TRUE~lubridate::myd(NA)
      ), 
    
    date_lact_end = case_when(
      date_left < date_archive ~ date_left, 
      date_archive < date_left ~ date_archive, 
      is.na(date_left) <1 ~date_left,
      is.na(date_archive)<1 ~ date_archive,
      lact_status %in% 'Active'~ data_pull_max,
      TRUE~lubridate::mdy(NA)
      ),

    
    
    lact_duration = as.numeric(date_lact_end-date_lact_start),
    
    qc_flag_lactation_duration = case_when(
      lact_duration<0~'negative duration', 
      lact_duration>(365*3)~'lactation > 3 yrs', 
      TRUE~'ok'),
    
    qc_complete_lactation = case_when(
      ((date_lact_start>=data_pull_min)&(date_lact_end<data_pull_max))~'complete lactation', 
      date_lact_start<data_pull_min~'missing begining', 
      lact_status %in% 'Active'~'active lactation', 
      TRUE~'incomplete lactation'),
    
    qc_flag_lact_end <- case_when(
      is.na(date_left)~'ok',
      (date_left %in% date_archive)~'ok', 
      TRUE~'flag lact end'), 
    
    qc_missing_lact_param = case_when(
    is.na(date_lact_start)~'missing start date', 
    is.na(date_lact_end)~'missing end date', 
    qc_date_fresh_diff>0~'multiple date_fresh', 
    qc_date_died_diff>0~'multiple date_died',
    date_sold_diff>0~'multiple date_sold',
    date_archive_diff>0~'multiple date_archive',

    TRUE~'ok'
  ))


```


```{r}
qc_lactations <- deno_base %>%
  select(id_animal_lact, location_lact_list, location_lact_list, date_lact_start, qc_missing_lact_param, qc_complete_lactation, qc_flag_lactation_duration) %>%
  mutate(lact_year_start = case_when(
    is.na(date_lact_start)~'Unknown',
    year(date_lact_start)<year(data_pull_max-(365*4))~paste0('<', year(data_pull_max-(365*4))), 
    TRUE~paste0(year(date_lact_start)))
    )%>%
  mutate(across(everything(), as.character)) %>%
  pivot_longer(
    cols = contains('qc'),
    names_to = "parameter",
    values_to = "outcome"
  )%>%
  mutate(outcome = replace_na(outcome, 'missing'))%>%
  group_by(location_lact_list, lact_year_start, parameter)%>%
  mutate(total_lactations = n_distinct(id_animal_lact))%>%
  ungroup()%>%
  group_by(location_lact_list, lact_year_start, parameter, total_lactations, outcome)%>%
  summarize(ct_lactations = n_distinct(id_animal_lact))%>%
  ungroup()%>%
  mutate(proportion = ct_lactations/total_lactations)

check<-deno_base%>%
  mutate(missing_start_date = is.na(date_lact_start))
  
  ggplot(check)+
  geom_bar(aes(x = 'problem', fill = missing_start_date), position = position_fill())+
    geom_hline(aes(yintercept = 0.02), color = 'red')+
    facet_grid(location_lact_list~.)+
    scale_fill_manual(values = c('grey', 'blue'))
```


```{r}
fxn_plot_qc<-function(choose_param){
ggplot(qc_lactations%>%filter(parameter %in% choose_param))+
  geom_col(aes(x = lact_year_start, y= proportion, fill = outcome))+
  geom_text(aes(x = lact_year_start, y= 0.01, label = paste0('n = ', total_lactations)), hjust = 0, color = 'grey30')+
  #theme(legend.position = 'none')+
  facet_grid(parameter~location_lact_list, scale = 'free')+
  theme_bw()+
  theme(legend.position = 'top')+
  labs(title = choose_param, 
       fill = '')+
  coord_flip()+
  scale_fill_manual(values = c( "active lactation" = 'grey50',
                                "complete lactation" = 'grey', 
                                "incomplete lactation" = 'cyan', 
                                "lactation > 3 yrs" = 'orange', 
                                "missing begining"  = 'gold', 
                                "missing start date" = 'purple', 
                                "multiple date_archive" = 'red', 
                                "multiple date_died" = 'red', 
                                "multiple date_fresh" = 'red', 
                                "multiple date_sold" = 'red', 
                                "negative duration" = 'hotpink', 
                                "ok" = 'grey' ))
}

#----------------------------
fxn_plot_qc(choose_param = "qc_complete_lactation")
fxn_plot_qc(choose_param = "qc_flag_lactation_duration"   )
fxn_plot_qc(choose_param =  "qc_missing_lact_param" )

```



```{r}
deno_all_lact<-deno_base%>%
  fxn_deno_eligible_entire_lactation() #animals are eligible the entire lactation

deno_milking<-deno_base%>%
  fxn_deno_eligible_milking() #animals are eligible only when milking

deno_dry<-deno_base%>%
  fxn_deno_eligible_dry() #animals are eligible only when dry

deno_period<-deno_base%>%
  fxn_deno_eligible_period()
```

### set base type used for calculations

```{r}
set_deno_base_type<-deno_all_lact
#set_deno_base_type<-deno_dry
#set_deno_base_type<-deno_dry

```


### plot variables in base data
```{r, fig.height=12}
sk_deno<-skimr::skim(deno_base)

ggplot(sk_deno)+
  geom_bar(aes(x = reorder(skim_variable, complete_rate), y = complete_rate, fill = skim_type), 
           stat = 'identity')+
  facet_wrap(skim_type~., scales = 'free', ncol = 1)+
  coord_flip()+
  scale_fill_viridis_d()

```


## Time period denominators


```{r}
cow_list<-sort(unique(deno_base$id_animal))
#i=1
#create bookends for period )
calendar2<-calendar%>%
  mutate(period_end = date_calendar, 
         period_start = lag(date_calendar))%>%
  filter(!is.na(period_start))%>%
  mutate(days_in_period = as.numeric(period_end-period_start))%>%
  mutate(period_complete = case_when(
    days_in_period == params$denominator_granularity~'complete', 
    TRUE~'Incomplete'
  ))
  


deno_by_period<-NULL

for (i in seq_along(calendar2$period_start)){

get_period_start<-calendar2$period_start[[i]]
get_period_end<-calendar2$period_end[[i]]
get_period_complete<-calendar2$period_complete[[i]]
get_days_in_period<-calendar2$days_in_period[[i]]

df_period<-deno_base%>%
  #filter(id_animal %in% sample(cow_list, 3))%>% #turn on for testing
  mutate(period_start = get_period_start, 
        period_end = get_period_end, 
        period_complete = get_period_complete, 
        days_in_period = get_days_in_period)%>%
  # filter(date_lact_start<=period_start)%>%
  # filter(date_lact_end>=period_end)%>%
  mutate(
    
    days_elig = case_when(
    (date_lact_start>=period_end)~0, 
    date_lact_end<period_start~0,
    ((date_lact_end<period_end)&(date_lact_start<=period_start))~as.numeric(date_lact_end-period_start), 
    ((date_lact_end<period_end)&(date_lact_start>=period_start))~as.numeric(period_end-date_lact_start), 
     ((date_lact_end>period_end)&(date_lact_start<=period_start))~as.numeric(period_end-period_start), 
    TRUE~as.numeric(NA) )
    )%>%
  select(days_elig, contains('period'), 
         date_lact_start, date_lact_end, lact_duration, 
         date_left, date_archive, everything())%>%
  mutate(qc_days_elig = case_when(
    days_elig >=0 ~ 'ok', 
    days_elig<0~'neg days elig', 
    is.na(days_elig)~'missing days elig',
    TRUE~'unknown'))

#----------------------------

df_period_summary<-df_period%>%
  group_by(location_lact_list, lact_group, period_start, period_end, days_in_period, period_complete, qc_days_elig)%>%
  filter(days_elig>0)%>%
  summarize(days_elig = sum(days_elig, na.rm = TRUE), 
            count_lactations = n_distinct(id_animal_lact), 
            count_animals = n_distinct(id_animal))%>%
  ungroup()%>%
  mutate(animal_periods = days_elig/days_in_period)

deno_by_period = bind_rows(deno_by_period, df_period_summary)

}

```

### write out files

```{r}

write_parquet(deno_by_period, 
              paste0('data/intermediate_files/deno_by_period_', params$denominator_granularity, '.parquet'))

```



## Calendar Denominators

```{r}
cow_list<-sort(unique(deno_base$id_animal))
#i=1
cal_seq<-tibble(date= seq.Date(data_pull_min, data_pull_max, by = 3))%>%
  mutate(floordate_year = floor_date(date, unit = 'years'), 
         floordate_season = floor_date(date, unit = 'season'),
         floordate_month = floor_date(date, unit = 'month'), 
         floordate_week = floor_date(date, unit = 'week')
  )

fxn_get_calendar<-function(date_var){
  cal_seq%>%
  select({{date_var}})%>%
  distinct()%>%
  rename(date_calendar = {{date_var}})%>%
  mutate(period_start = date_calendar, 
         period_end = lead(date_calendar))%>%
  mutate(period_end = case_when(
    is.na(period_end)~data_pull_max, 
    TRUE~period_end)
    )%>%
  mutate(days_in_period = as.numeric(period_end-period_start))
}

calendar_year<-fxn_get_calendar(date_var = 'floordate_year')
calendar_season<-fxn_get_calendar(date_var = 'floordate_season')
calendar_month<-fxn_get_calendar(date_var = 'floordate_month')
calendar_week<-fxn_get_calendar(date_var = 'floordate_week')


```


### Function 

```{r}

fxn_create_deno_calendar<-function(calendar2){

deno_by_period<-NULL



for (i in seq_along(calendar2$period_start)){

get_period_start<-calendar2$period_start[[i]]
get_period_end<-calendar2$period_end[[i]]
get_days_in_period<-calendar2$days_in_period[[i]]

df_period<-deno_base%>%
  #filter(id_animal %in% sample(cow_list, 3))%>% #turn on for testing
  mutate(period_start = get_period_start, 
        period_end = get_period_end, 
        days_in_period = get_days_in_period)%>%
  # filter(date_lact_start<=period_start)%>%
  # filter(date_lact_end>=period_end)%>%
  mutate(days_elig = case_when(
    (date_lact_start>=period_end)~0, 
    date_lact_end<period_start~0,
  
    ((date_lact_end<period_end)&(date_lact_start<=period_start))~as.numeric(date_lact_end-period_start), 
    ((date_lact_end<period_end)&(date_lact_start>=period_start))~as.numeric(period_end-date_lact_start), 
     ((date_lact_end>period_end)&(date_lact_start<=period_start))~as.numeric(period_end-period_start), 
    TRUE~as.numeric(NA)
  ))%>%
  select(days_elig, contains('period'), 
         date_lact_start, date_lact_end, lact_duration, 
         date_left, date_archive, everything())%>%
  mutate(qc_days_elig = case_when(
    days_elig >=0 ~ 'ok', 
    days_elig<0~'neg days elig', 
    is.na(days_elig)~'missing days elig',
    TRUE~'unknown'))

#----------------------------

df_1<-df_period%>%
  group_by(location_lact_list, lact_group, period_start, period_end, days_in_period,  qc_days_elig)%>%
  filter(days_elig>0)%>%
  summarize(days_elig = sum(days_elig, na.rm = TRUE), 
            count_lactations = n_distinct(id_animal_lact), 
            count_animals = n_distinct(id_animal))%>%
  ungroup()%>%
  mutate(animal_periods = days_elig/days_in_period)%>%
  mutate(`Lactation Group` = lact_group)

df_2<-df_period%>%
  group_by(location_lact_list, lact_group_basic, period_start, period_end, days_in_period,  qc_days_elig)%>%
  filter(days_elig>0)%>%
  summarize(days_elig = sum(days_elig, na.rm = TRUE), 
            count_lactations = n_distinct(id_animal_lact), 
            count_animals = n_distinct(id_animal))%>%
  ungroup()%>%
  mutate(animal_periods = days_elig/days_in_period)%>%
  mutate(`Lactation Group` = lact_group_basic)

df_3<-df_period%>%
  group_by(location_lact_list, lact_group_repro, period_start, period_end, days_in_period,  qc_days_elig)%>%
  filter(days_elig>0)%>%
  summarize(days_elig = sum(days_elig, na.rm = TRUE), 
            count_lactations = n_distinct(id_animal_lact), 
            count_animals = n_distinct(id_animal))%>%
  ungroup()%>%
  mutate(animal_periods = days_elig/days_in_period)%>%
  mutate(`Lactation Group` = lact_group_repro)

df_4<-df_period%>%
  group_by(location_lact_list, lact_group_5, period_start, period_end, days_in_period,  qc_days_elig)%>%
  filter(days_elig>0)%>%
  summarize(days_elig = sum(days_elig, na.rm = TRUE), 
            count_lactations = n_distinct(id_animal_lact), 
            count_animals = n_distinct(id_animal))%>%
  ungroup()%>%
  mutate(animal_periods = days_elig/days_in_period)%>%
  mutate(`Lactation Group` = lact_group_5)

df_master<-bind_rows(df_1, df_2, df_3, df_4)%>%
  distinct()

deno_by_period <<- bind_rows(deno_by_period, df_master)


}

}

```

#### function to plot denos

```{r}
fxn_plot_deno_types<-function(deno_type){
  
  deno_type_long<-deno_type%>%
    select(period_start, count_animals, count_lactations, animal_periods,  `Lactation Group`, location_lact_list)%>%
    pivot_longer(cols = c('count_animals', 'count_lactations', 'animal_periods'), 
                 names_to = 'metric', 
                 values_to = 'count')
  
p1<-ggplot(deno_type_long)+
  geom_smooth(aes(x = period_start, y = count, color = metric, fill = metric, group = metric))+
  geom_point(aes(x = period_start, y = count, color = metric), size = 1)+
  facet_grid(location_lact_list~`Lactation Group`)

p2<-ggplot(deno_type)+
  geom_smooth(aes(x = count_animals, y = count_lactations, 
                  color = `Lactation Group`, fill = `Lactation Group`, group = `Lactation Group`))+
  facet_wrap(.~location_lact_list, scales =  'free')+
  theme_bw()+
  theme(aspect.ratio = 1)

# p3<-ggplot(deno_type)+
#   geom_smooth(aes(x = period_start, y = animal_periods, color = lact_group, fill = lact_group, group = lact_group))+
#   geom_point(aes(x = period_start, y = animal_periods, color = lact_group), size = 1)+
#   facet_grid(.~location_lact_list)

print(p1) 
print(p2) 
# print(p3)

}

```


### Year 

```{r}
fxn_create_deno_calendar(calendar2 = calendar_year)
deno_calendar_year<-deno_by_period

fxn_plot_deno_types(deno_type = deno_calendar_year)
```

### Season

```{r}
fxn_create_deno_calendar(calendar2 = calendar_season)
deno_calendar_season<-deno_by_period

fxn_plot_deno_types(deno_calendar_season)

```

### Month

```{r}
fxn_create_deno_calendar(calendar2 = calendar_month)
deno_calendar_month<-deno_by_period

fxn_plot_deno_types(deno_calendar_month)
```

### Week

```{r}
fxn_create_deno_calendar(calendar2 = calendar_week)
deno_calendar_week<-deno_by_period

fxn_plot_deno_types(deno_calendar_week)

```

### write out files

```{r}

write_parquet(deno_calendar_year, 
              paste0('data/intermediate_files/deno_calendar_year.parquet'))

write_parquet(deno_calendar_season, 
              paste0('data/intermediate_files/deno_calendar_season.parquet'))

write_parquet(deno_calendar_month, 
              paste0('data/intermediate_files/deno_calendar_month.parquet'))

write_parquet(deno_calendar_week, 
              paste0('data/intermediate_files/deno_calendar_week.parquet'))

```



## Denominators by day of phase (under development)

### Count cows on each calendar day for different dim groups

This loops over the list of calendar days and counts the number of eligible cows each date.  It prints out the date as it does it so you can see progress.  The loop speed is pretty much the same regardless of how many rows (animals) are in the base data.  The speed is limited by the length of the list of calendar dates until very very large herds are used.

```{r, message = FALSE}
#set_dim_breaks<-30
set_dim_breaks<-seq(0, 1500, by = params$denominator_granularity)

fxn_create_deno_phase<-function(set_calendar_for_phase = calendar2, set_dim_breaks){
  
  deno_dataframe_phase<<-NULL
#i=1
for (i in seq_along(set_calendar_for_phase$period_start)){

get_period_start<-set_calendar_for_phase$period_start[[i]]
get_period_end<-set_calendar_for_phase$period_end[[i]]
get_days_in_period<-set_calendar_for_phase$days_in_period[[i]]

df_period<-deno_base%>%
  #filter(id_animal %in% sample(cow_list, 200))%>% #turn on for testing
  mutate(period_start = get_period_start, 
        period_end = get_period_end, 
        days_in_period = get_days_in_period)%>%
   mutate(
     dim_at_period_start = case_when(
        date_lact_start>period_start~as.numeric(NA),
        date_lact_end<period_start~as.numeric(NA),
      #((period_start>=date_lact_start)&(period_start<date_lact_end))~as.numeric(period_start-date_lact_start), 
      TRUE~as.numeric(period_start-date_lact_start)), 
     
     dim_at_period_end = case_when(
          date_lact_end<period_end~as.numeric(NA),
        date_lact_start>period_end~as.numeric(NA),
       TRUE~as.numeric(period_end-date_lact_start)
       )
   )%>%
    mutate(dim_group_start = cut(dim_at_period_start, breaks = set_dim_breaks), 
            dim_group_end = cut(dim_at_period_end, breaks = set_dim_breaks))%>%
  # filter(date_lact_start<=period_start)%>%
  # filter(date_lact_end>=period_end)%>%
  mutate(days_elig = case_when(
    (date_lact_start>=period_end)~0, 
    (date_lact_end<period_start)~0,
    
     ((is.na(dim_at_period_start)<1)&((is.na(dim_at_period_end)<1)))~as.numeric(dim_at_period_end-dim_at_period_start),
     ((is.na(dim_at_period_start)<1)&((is.na(dim_at_period_end)>0)))~as.numeric(date_lact_end-period_start),
     ((is.na(dim_at_period_start)>0)&((is.na(dim_at_period_end)<1)))~as.numeric(period_end-date_lact_start),

    TRUE~as.numeric(NA)
  ))%>%
  select(days_elig, contains('period'), 
         dim_group_start, dim_group_end,
         date_lact_start, date_lact_end, lact_duration, 
         date_left, date_archive, everything())%>%
  mutate(qc_days_elig = case_when(
    days_elig >=0 ~ 'ok', 
    days_elig<0~'neg days elig', 
    is.na(days_elig)~'missing days elig',
    TRUE~'unknown'))

#----------------------------

df_1<-df_period%>%
  filter(!(is.na(dim_group_start)))%>%
  group_by(location_lact_list, lact_group, 
           dim_group_start, 
           period_start, period_end, days_in_period,  qc_days_elig)%>%
  #filter(days_elig>0)%>%
  summarize(days_elig = sum(days_elig, na.rm = TRUE), 
            count_lactations = n_distinct(id_animal_lact), 
            count_animals = n_distinct(id_animal))%>%
  ungroup()%>%
  mutate(animal_periods = days_elig/days_in_period)%>%
  mutate(type = lact_group)%>%
  mutate(`Lactation Group` = lact_group)

df_2<-df_period%>%
  filter(!(is.na(dim_group_start)))%>%
  group_by(location_lact_list, lact_group_basic, 
           dim_group_start, 
           period_start, period_end, days_in_period,  qc_days_elig)%>%
  #filter(days_elig>0)%>%
  summarize(days_elig = sum(days_elig, na.rm = TRUE), 
            count_lactations = n_distinct(id_animal_lact), 
            count_animals = n_distinct(id_animal))%>%
  ungroup()%>%
  mutate(animal_periods = days_elig/days_in_period)%>%
  mutate(type = lact_group_basic)%>%
  mutate(`Lactation Group` = lact_group_basic)

df_3<-df_period%>%
  filter(!(is.na(dim_group_start)))%>%
  group_by(location_lact_list, lact_group_repro, 
           dim_group_start, 
           period_start, period_end, days_in_period,  qc_days_elig)%>%
  #filter(days_elig>0)%>%
  summarize(days_elig = sum(days_elig, na.rm = TRUE), 
            count_lactations = n_distinct(id_animal_lact), 
            count_animals = n_distinct(id_animal))%>%
  ungroup()%>%
  mutate(animal_periods = days_elig/days_in_period)%>%
  mutate(type = lact_group_repro)%>%
  mutate(`Lactation Group` = lact_group_repro)

df_4<-df_period%>%
  filter(!(is.na(dim_group_start)))%>%
  group_by(location_lact_list, lact_group_5, 
           dim_group_start, 
           period_start, period_end, days_in_period,  qc_days_elig)%>%
  #filter(days_elig>0)%>%
  summarize(days_elig = sum(days_elig, na.rm = TRUE), 
            count_lactations = n_distinct(id_animal_lact), 
            count_animals = n_distinct(id_animal))%>%
  ungroup()%>%
  mutate(animal_periods = days_elig/days_in_period)%>%
  mutate(type = lact_group_5)%>%
  mutate(`Lactation Group` = lact_group_5)

df_master<-bind_rows(df_4, df_3, df_2, df_1)%>%
  distinct()

deno_dataframe_phase <<-bind_rows(deno_dataframe_phase, df_master)

print(i)

     }
  
  }
```


## DIM by period

```{r, message = FALSE}
fxn_create_deno_phase(set_calendar_for_phase = calendar2, 
                                         set_dim_breaks = set_dim_breaks)
deno_phase_period<-deno_dataframe_phase

write_parquet(deno_phase_period, 
              paste0('data/intermediate_files/deno_dim_period_', params$denominator_granularity, '.parquet'))

```

## DIM by calendar periods

```{r, message = FALSE}
#year -----------------------------
fxn_create_deno_phase(set_calendar_for_phase = calendar_year,  
                                         set_dim_breaks = set_dim_breaks)
deno_phase_calendar_year<-deno_dataframe_phase

write_parquet(deno_phase_calendar_year, 
              paste0('data/intermediate_files/deno_dim_calendar_year.parquet'))

#season -----------------------------
fxn_create_deno_phase(set_calendar_for_phase = calendar_season,  
                                         set_dim_breaks = set_dim_breaks)
deno_phase_calendar_season<-deno_dataframe_phase

write_parquet(deno_phase_calendar_season, 
              paste0('data/intermediate_files/deno_dim_calendar_season.parquet'))

#year -----------------------------
fxn_create_deno_phase(set_calendar_for_phase = calendar_month,  
                                         set_dim_breaks = set_dim_breaks)
deno_phase_calendar_month<-deno_dataframe_phase

write_parquet(deno_phase_calendar_month, 
              paste0('data/intermediate_files/deno_dim_calendar_month.parquet'))

#year -----------------------------
fxn_create_deno_phase(set_calendar_for_phase = calendar_week,  
                                         set_dim_breaks = set_dim_breaks)
deno_phase_calendar_week<-deno_dataframe_phase

write_parquet(deno_phase_calendar_week, 
              paste0('data/intermediate_files/deno_dim_calendar_week.parquet'))

```

## Match Gerard


### DIM
```{r}
herd_deno_dim_gerard<-read_parquet('data/intermediate_files/herd_dim_denominators.parquet')%>%
  rename(count_lactations = count)%>%
  separate(DIM, into = c('dim_low', 'dim_high', 'other'))%>%
  arrange(location_lact_list, time_period, `Lactation Group`, dim_low, dim_high, count_lactations)

herd_deno_dim_new<-deno_phase_calendar_year%>%
  mutate(time_period = year(period_start), 
         DIM = dim_group_start)%>%
  filter(time_period %in% '2025')%>%
    filter(!(str_detect(`Lactation Group`, 'Heifer')))%>%
  arrange(location_lact_list, time_period, `Lactation Group`, DIM, count_lactations)%>%
  separate(DIM, into = c('other1', 'dim_low', 'dim_high', 'other'))%>%
    select(colnames(herd_deno_dim_gerard))%>%
  arrange(location_lact_list, time_period, `Lactation Group`, dim_low, dim_high, count_lactations)%>%
  distinct()



waldo::compare(herd_deno_dim_gerard, herd_deno_dim_new)

```

```{r}
ggplot(herd_deno_dim_gerard)+
  geom_point(aes(x = time_period, y = count_lactations, color = dim_low))+
  facet_grid(location_lact_list~`Lactation Group`)+
  labs(title = 'Gerard')

ggplot(herd_deno_dim_new)+
  geom_point(aes(x = time_period, y = count_lactations, color = dim_low))+
  facet_grid(location_lact_list~`Lactation Group`)+
  labs(title = 'New')
```


### Lact group and Year
```{r}
herd_deno_gerard<-read_parquet('data/intermediate_files/herd_denominators.parquet')

herd_deno_new<-deno_calendar_year%>%
  select(colnames(herd_deno_gerard))

```


### Lact gorup and Month
```{r}
herd_deno_season_gerard<-read_parquet('data/intermediate_files/herd_season_denominators.parquet')%>%
  select(location_lact_list, everything())

herd)deno_season_new <-deno_calendar_month

```




#####****JUNK************


```{r}
fxn_create_deno<-function(time_period){
  denominator_granular%>%
    group_by(location_lact_list, `Lactation Group`, {{time_period}})%>%
    #group_by(`Lactation Group`, floordate_calendar_year)%>%
    summarize(time_period_start = min(date_calendar), 
              time_period_end = max(date_calendar), 
              animal_count_mean = round(mean(ct_animals), digits = 0), 
              animal_count_sd = round(sd(ct_animals), digits = 0), 
              animal_count_min = min(ct_animals), 
              animal_count_max = max(ct_animals))%>%
    ungroup()
}

denominator_year<-fxn_create_deno(time_period = floordate_calendar_year)
denominator_season<-fxn_create_deno(time_period = floordate_calendar_season)
denominator_month<-fxn_create_deno(time_period = floordate_calendar_month)
denominator_week<-fxn_create_deno(time_period = floordate_calendar_week)

denominator_time_period<-bind_rows(denominator_year, denominator_season, denominator_month, denominator_week)%>%
  select(`Lactation Group`, location_lact_list, contains('time_period'), contains('animal'), contains('floordate'))%>%
  mutate(time_period_type = case_when(
    (is.na(floordate_calendar_year)<1)~'year', 
    (is.na(floordate_calendar_season)<1)~'season', 
    (is.na(floordate_calendar_month)<1)~'month', 
    (is.na(floordate_calendar_week)<1)~'week', 
    TRUE~'unknown')
  )%>%
    select(time_period_type, everything())


write_parquet(denominator_time_period, 'data/intermediate_files/denominator_time_period.parquet')



#display table-----------------
fxn_DT_base(denominator_time_period)
```


### Plot time period denominators

```{r}

ggplot(denominator_time_period)+
  geom_linerange(aes(y = animal_count_mean, 
                     xmin = time_period_start, 
                     xmax = time_period_end))+
  facet_grid(`Lactation Group`~location_lact_list)
  

```






## Count cows on each calendar day for differnt lacation groups

This loops over the list of calendar days and counts the number of eligible cows each date.  It prints out the date as it does it so you can see progress.  The loop speed is pretty much the same regardless of how many rows (animals) are in the base data.  The speed is limited by the length of the list of calendar dates until very very large herds are used.

```{r, message = FALSE}

#make a place to put the results
deno_dataframe<-NULL


#i = 324
for (i in seq_along(calendar$date_calendar)){
  
  #faster------------------------------------------
  df<-set_deno_base_type%>%
    #test%>%
    mutate(date_ref = calendar$date_calendar[[i]])%>%
    mutate(eligible = case_when(
      ((date_elig_start<=date_ref)&(date_elig_end>date_ref))~1, #inclusive at begining but not end
      TRUE~0
    ))
  
  df2<-df%>%
    filter(eligible>0)%>%
    group_by(location_lact_list, lact_group_basic, date_ref) |> 
    summarize(ct_lacts = sum(eligible), 
              ct_animals = n_distinct(id_animal))%>%
    ungroup() |> 
    rename(`Lactation Group` = lact_group_basic)
  
  df3<-df%>%
    filter(eligible>0)%>%
    group_by(location_lact_list, lact_group, date_ref) |> 
    summarize(ct_lacts = sum(eligible), 
              ct_animals = n_distinct(id_animal))%>%    ungroup()|> 
    rename(`Lactation Group` = lact_group)
  
  df4<-df%>%
    filter(eligible>0)%>%
    group_by(location_lact_list, lact_group_5, date_ref) |> 
    summarize(ct_lacts = sum(eligible), 
              ct_animals = n_distinct(id_animal))%>%    ungroup()|> 
    rename(`Lactation Group` = lact_group_5)
  
 
  #final df---------------------------
  df10<-bind_rows(df2, df3, df4)%>%
    distinct()
  
  deno_dataframe <-bind_rows(deno_dataframe, df10) 
  
  print(calendar$date_calendar[[i]])
    
}
  




```




### Plot Counts by Lactation Groups

This is a plot of the granular dataframe.  It displays the count of cows on each reference date.

```{r}
#fast method-------------------
ggplot(deno_dataframe)+
  geom_point(aes(x = date_ref, y = ct_animals, color = `Lactation Group`))+
  ylim(c(0, NA))+
  facet_wrap(location_lact_list~.)

```




## Granular denominator

For most reporting the time period reported will be longer than one day.  However, here is the most granular denominator. 

```{r}

denominator_granular<-deno_dataframe%>%
  #filter(eligible %in% 'eligible')%>%
  rename(date_calendar = date_ref)%>%
  mutate(floordate_calendar_year = floor_date(date_calendar, unit = 'years'),
         floordate_calendar_season = floor_date(date_calendar, unit = 'seasons'),
         floordate_calendar_month = floor_date(date_calendar, unit = 'months'),
         floordate_calendar_week = floor_date(date_calendar, unit = 'weeks') )%>%
  select(location_lact_list, `Lactation Group`, ct_animals, ct_lacts, contains('date'))

write_parquet(denominator_granular, 'data/intermediate_files/denominator_calendar_time.parquet')



#display table--------------------
fxn_DT_base(head(denominator_granular, 500))

```

### Match Gerard Denominator
```{r}

fxn_summarize_denos<-function(df){
  df%>%
    summarize(count_animals = round(mean(ct_animals), digits = 0), 
            count_lactations = round(mean(ct_lacts), digits = 0), 
            
            min_animals = min(ct_animals), 
            max_animals = max(ct_animals), 
            sd_animals = sd(ct_animals), 
            median_animals = median(ct_animals),
            
            min_lacts = min(ct_lacts), 
            max_lacts = max(ct_lacts), 
            sd_lacts = sd(ct_lacts), 
            median_lacts = median(ct_lacts)
            )%>%
  ungroup()
    
}

#--------------------------------------------
herd_deno<-denominator_granular%>%
  group_by(floordate_calendar_year, location_lact_list, 
           `Lactation Group`)%>%
  fxn_summarize_denos()%>%
  mutate(time_period = year(floordate_calendar_year))%>%
  select(location_lact_list, time_period, `Lactation Group`, 
         count_animals, count_lactations, everything() )

write_parquet(herd_deno, 'data/intermediate_files/herd_denominators2.parquet')
            

gerard_herd_deno<-read_parquet('data/intermediate_files/herd_denominators.parquet')

#--------------------------------------------

herd_deno_month<-denominator_granular%>%
  group_by(floordate_calendar_month, location_lact_list, 
           `Lactation Group`)%>%
  fxn_summarize_denos()%>%
  mutate(time_period = year(floordate_calendar_month))%>%
  select(location_lact_list, time_period, `Lactation Group`, 
         count_animals, count_lactations, everything() )

write_parquet(herd_deno_month, 'data/intermediate_files/herd_season_denominators2.parquet')

write_parquet(herd_deno_month, 'data/intermediate_files/herd_month_denominators2.parquet')
            

gerard_herd_deno_season<-read_parquet('data/intermediate_files/herd_season_denominators.parquet')%>%
  select(location_lact_list, everything())



```


## Denominators by day of phase (under development)

### Count cows on each calendar day for different dim groups

This loops over the list of calendar days and counts the number of eligible cows each date.  It prints out the date as it does it so you can see progress.  The loop speed is pretty much the same regardless of how many rows (animals) are in the base data.  The speed is limited by the length of the list of calendar dates until very very large herds are used.

```{r, message = FALSE}



#set_dim_breaks<-30
set_dim_breaks<-seq(0, 400, by = 30)


#make a place to put the results
deno_dataframe_phase<-NULL

#i = 1
for (i in seq_along(calendar$date_calendar)){
  
  #faster------------------------------------------
  df<-set_deno_base_type%>%
    #test%>%
    mutate(date_ref = calendar$date_calendar[[i]])%>%
    mutate(dim_at_date_ref = case_when(
      ((date_ref>=date_elig_start)&(date_ref<date_elig_end))~as.numeric(date_ref-date_fresh), 
      TRUE~as.numeric(NA))
      )%>%
        mutate(dim_group = cut(dim_at_date_ref, breaks = set_dim_breaks))
    

  df3<-df%>%
    filter(!(is.na(dim_group)))%>%
    group_by(location_lact_list, lact_group, date_ref, dim_group) |> 
    summarize(ct_lacts = n_distinct(id_animal_lact), 
              ct_animals = n_distinct(id_animal)
              )%>%
    ungroup()|> 
    rename(`Lactation Group` = lact_group)
  
  
  df4<-df%>%
    filter(!(is.na(dim_group)))%>%
    group_by(location_lact_list, lact_group_basic, date_ref, dim_group) |> 
    summarize(ct_lacts = n_distinct(id_animal_lact), 
              ct_animals = n_distinct(id_animal)
              )%>%
    ungroup()|> 
    rename(`Lactation Group` = lact_group_basic)
  
  
 
 
  #final df---------------------------
  df10<-bind_rows(df3, df4)%>%
    distinct()
  
  deno_dataframe_phase <-bind_rows(deno_dataframe_phase, df10)
  
  print(calendar$date_calendar[[i]])
    
}

write_parquet(deno_dataframe_phase, 'data/intermediate_files/denominator_phase_time.parquet')

#-----------------------------------------

herd_deno_dim<-deno_dataframe_phase%>%
  mutate(time_period = floor_date(date_ref, unit = 'months'))%>%
  group_by(time_period, dim_group, `Lactation Group`, location_lact_list )%>%
  fxn_summarize_denos()

write_parquet(herd_deno_dim, 'data/intermediate_files/herd_dim_denominators2.parquet')


gerard_herd_deno_dim<-read_parquet('data/intermediate_files/herd_dim_denominators.parquet')
```


### plot phase denominators


```{r}

ggplot(deno_dataframe_phase)+
  geom_point(aes(x = date_ref, y = ct_lacts, color = dim_group))+
  ylim(c(0, NA))+
  facet_grid(location_lact_list~`Lactation Group`)

```
## Compare new and old

```{r}
waldo::compare(
colnames(gerard_herd_deno_dim),
colnames(herd_deno_dim%>%
           select(location_lact_list, time_period,
                  `Lactation Group`, everything()))
)
```


```{r}
waldo::compare(
colnames(gerard_herd_deno_season),
colnames(herd_deno_month)
)
```


```{r}
waldo::compare(
colnames(gerard_herd_deno),
colnames(herd_deno) 
)



```
## compare herd

```{r}
compare_values_herd<-bind_rows(gerard_herd_deno%>%mutate(type = 'Gerard'), 
                          herd_deno %>% mutate(type = 'New'))

ggplot(compare_values_herd)+
  geom_point(aes(x = time_period, y = count_animals, color = type))+
  facet_wrap(`Lactation Group`~location_lact_list, scales = 'free')+
  ylim(c(0, NA))

ggplot(compare_values_herd)+
  geom_col(aes(x = time_period, y = count_lactations, fill = type), position = 'dodge')+
  facet_wrap(`Lactation Group`~location_lact_list, scales = 'free')+
  ylim(c(0, NA))

```

## compare dim

```{r}
compare_values_dim<-bind_rows(gerard_herd_deno_dim%>%mutate(type = 'Gerard')%>%
                                mutate(time_period = as.character(time_period)), 
                              herd_deno_dim %>% mutate(type = 'New')%>%
                                mutate(time_period = as.character(time_period)))

ggplot(compare_values_dim)+
    geom_col(data = gerard_herd_deno_dim%>%mutate(type = 'Gerard')%>%
               mutate(time_period = as.character(time_period))%>%
               mutate(dim_group = DIM),
             aes(x = time_period, y = count, fill = type), position = 'dodge', color = 'salmon')+

  geom_col(aes(x = time_period, y = count_animals, fill = `Lactation Group`), position = 'dodge')+
  facet_wrap(`Lactation Group`~type, scales = 'free')+
  ylim(c(0, NA))

```

