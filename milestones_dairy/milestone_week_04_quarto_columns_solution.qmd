---
title: Read and Visualize
date: "`r Sys.Date()`"
embed-resources: true
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(echo = TRUE)

# This chunck is already finished for you, you don't need to modify anything here
library(tidyverse) #this includes many packages and is the main package used in nearly all data wrangling
library(arrow) #this package handles parquet files
library(skimr) #this is particularly helpful when looking at new data or finding NA values
library(waldo) #we use this to create answer keys for these exercises


#add some extra functions
source('../functions/fxn_add_event_counts.R')
source('data_milestones/fxn_floor_dates.R')


```

## Create and select columns

In this milestone, you'll write some of the code that was written for you in milestone 3.

1.  Read in **events_formatted.parque**t from the **../data/intermediate_files**, and name it **events_formatted. Then filter so you only have the events: FRESH, BRED, LAME, MAST, DRY, SOLD, DIED**
2.  create a new variable named **floordate_month**. The logic to create this variable is: **floor_date(date_event, 'months')**
3.  arrange the data by 3 variables: the cow the event, and then the event date. In this data set these variables are named: id_animal, event, event_date
4.  Pipe your events_formatted to the function fxn_add_event_counts(). This will add columns indicating the number of times the animal has had that event within the data set (event_count_animal) or within their lactation (event_count_lact).
5.  Create a new dataframe the filters to only include FRESH, BRED, MAST

```{r}
#| label: recreation-import
#| 
lame_events<-read_parquet('../data/intermediate_files/events_formatted.parquet')%>%
  filter(event %in% c(#'FRESH', 'BRED', 
                      'LAME'#, 
                      #'MAST', 'DRY'
                      ))%>%
  mutate(floordate_month = floor_date(date_event, 'months'))%>%
  fxn_add_event_counts()%>%
  select(location_event, 
         id_animal, 
         id_animal_lact,lact_number, 
         dim_event, 
         floordate_month, 
         event, remark, protocols, 
         event_count_lact,
         event_count_animal)

```

### Part 2 - Create and Summarize

Run the code below to see a table.

```{r}
#| label: recreate-this
#| message: false
solution <- readr::read_csv("data/milestone04.csv")
solution
```

Your task is to use what you've learned about the dplyr package to transform `mdrd` into this table. You will need to:

1.  Create a new column named `kidney_stage` that represents the current stage of chronic kidney disease based on GFR. Use the information below to create the new column with the following values:

    -   `1` if `gfr` is greater than or equal to 90
    -   `2` if `gfr` is greater than or equal to 60 (and less than 90)\
    -   `3` if `gfr` is greater than or equal to 30 (and less than 60)
    -   `4` if `gfr` is greater than or equal to 15 (and less than 30)
    -   `5` otherwise

*Hint: the `case_when()` function from dplyr is useful for situations like this.*

```{r}
skimr::skim(mdrd)
```

```{r}
mdrd2<-mdrd%>%
  #mutate(gfr = parse_number(gfr))%>%
  mutate(kidney_stage = case_when(
    (gfr>=90)~1,
    (gfr>=60)~2,
    (gfr>=30)~3,
    (gfr>=15)~4,
    (gfr<15)~5,
    TRUE ~ as.numeric(NA)
  ))

mdrd3<-mdrd2%>%
  arrange(ptid, months)%>%
  group_by(kidney_stage, ptid)%>%
  summarize(gfr1st = first(gfr), 
         gfrLast = last(gfr),
         time1st = first(months),
         timeLast = last(months))%>%
  ungroup()%>%
  mutate(gfr_slope = (gfrLast-gfr1st)/(timeLast-time1st))


```

2.  Group the result by `kidney_stage` and `ptid`.

3.  Summarize the `gfr_slope` for each patient. *Hint: You can reuse your code from Milestone 3 to calculate `gfr_slope`.*

Work in the code chunk below. Save the result as `mdrd_stages`.

```{r}
#| label: recreation-create
# DO NOT INSTALL TIDYVERSE PACKAGES
# Remember that all tidyverse packages have already been installed for you,
# but you will need to *load* the ones you want to use. As a best practice when
# working within a Quarto document like this one, load any packages you
# will use within the code chunk labeled `setup` at the top of the file.
```

Run the following code chunk to test whether you have the same answer as the solution:

```{r}
#| label: compare
#| eval: false
waldo::compare(mdrd_stages, solution, tolerance = 1e-4, ignore_attr = .groups)
```

## Extension

Using the code chunk below, investigate a research question about this data, using the additional data wrangling skills you learned this week. Some ideas:

1.  Which stage(s) of kidney disease are most common in this sample?
2.  How many patients in this sample progress through different stages of kidney disease over the course of the study? Do all patients who progress through different stages demonstrate improved kidney function over time? Are there any patients that get worse?
3.  Do you think a patient's current stage of kidney disease would be a useful way to predict the change in GFR over time (`gfr_slope`)?
4.  \[any other research question of interest\]

Alternately, working with a data set of your own, complete the following:

1.  Read in your data
2.  Create at least one new variable in your data set (using `mutate()` and/or `summarize()`), or use other dplyr functions to alter your data
3.  Use your updated data set to create at least one graph and/or table

```{r}
#| label: extension

```
